<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VimaClawNet 机器池控制台</title>
    <style>
      :root {
        font-family: "Satoshi", "Manrope", "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
        color: #0f172a;
        background: #eef2f7;
        --panel: #ffffff;
        --stroke: #dbe2ee;
        --ink: #0f172a;
        --muted: #64748b;
        --accent: #1d9bf0;
        --accent-dark: #0f6db8;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background: radial-gradient(circle at top left, #dff2ff 0%, #f2f7fd 48%, #eef2f7 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .shell {
        width: min(1320px, 100%);
        margin: 0 auto;
        display: grid;
        gap: 14px;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 16px;
        padding: 14px;
      }
      h1 {
        margin: 0 0 6px;
        font-size: 24px;
      }
      .sub {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
      }
      .toolbar {
        display: grid;
        grid-template-columns: 1.2fr 1.2fr 1fr auto;
        gap: 10px;
        margin-top: 12px;
      }
      .toolbar input,
      .toolbar button,
      .form-grid input,
      .form-grid select,
      .deploy-grid input,
      .deploy-grid button,
      .routing-table input {
        width: 100%;
        border: 1px solid var(--stroke);
        border-radius: 10px;
        padding: 10px 11px;
        font-size: 14px;
        background: #fff;
      }
      button {
        border: none;
        background: var(--accent);
        color: #fff;
        cursor: pointer;
        font-weight: 600;
      }
      button:hover { background: var(--accent-dark); }
      .status {
        margin-top: 10px;
        font-size: 13px;
        color: var(--muted);
      }
      .split {
        display: grid;
        grid-template-columns: 1.15fr 1fr;
        gap: 14px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th, td {
        border-bottom: 1px solid #edf2f8;
        padding: 9px 8px;
        text-align: left;
        vertical-align: top;
      }
      th { color: var(--muted); font-weight: 600; }
      tr.pick { background: #f0f8ff; }
      .pill {
        font-size: 12px;
        border-radius: 999px;
        padding: 3px 9px;
        border: 1px solid transparent;
        display: inline-flex;
      }
      .pill.online { background: #dcfce7; border-color: #86efac; color: #166534; }
      .pill.offline { background: #fee2e2; border-color: #fecaca; color: #991b1b; }
      .small {
        font-size: 12px;
        color: var(--muted);
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 180px;
        gap: 10px;
        margin-bottom: 10px;
      }
      .routing-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
      }
      .routing-table td,
      .routing-table th {
        border: none;
        padding: 0 6px;
      }
      .routing-table th {
        font-size: 12px;
        color: var(--muted);
      }
      .routing-table td.mode {
        font-weight: 700;
        width: 72px;
        color: var(--ink);
      }
      .actions {
        display: flex;
        gap: 10px;
        margin-top: 12px;
      }
      .muted-btn {
        background: #334155;
      }
      .deploy-grid {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1.1fr 1fr 1fr 1fr auto;
        gap: 10px;
      }
      pre {
        margin: 10px 0 0;
        background: #0f172a;
        color: #e2e8f0;
        border-radius: 12px;
        padding: 12px;
        font-size: 12px;
        white-space: pre-wrap;
      }
      .top-links {
        margin-top: 12px;
        display: flex;
        gap: 10px;
      }
      .top-links a {
        color: var(--accent-dark);
        text-decoration: none;
        font-size: 13px;
        font-weight: 600;
      }
      @media (max-width: 1080px) {
        .split { grid-template-columns: 1fr; }
        .toolbar,
        .deploy-grid,
        .form-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <section class="card">
        <h1>VimaClawNet 机器池控制台</h1>
        <p class="sub">查看在线 OpenClaw 机器，按 quick/code/deep 或 inst_*（模型档位）做路由与模型提示配置。</p>
        <div class="top-links">
          <a href="/">返回聊天页</a>
          <a href="/healthz" target="_blank" rel="noopener noreferrer">健康检查</a>
        </div>
        <div class="toolbar">
          <input id="baseUrl" placeholder="Server URL" />
          <input id="authToken" placeholder="Admin Token 或用户 Token" />
          <input id="userId" placeholder="用户ID（非管理员模式必填）" />
          <button id="loadMachines">加载机器池</button>
        </div>
        <div class="status" id="status">准备就绪。</div>
      </section>

      <section class="card">
        <h3 style="margin: 0 0 8px;">上传者登录并获取 Token（网页 GUI）</h3>
        <p class="small">上传者可在此用 userId + password 登录并一键生成 host token，再用于本地节点接入。</p>
        <div class="deploy-grid" style="grid-template-columns: 1fr 1fr auto auto;">
          <input id="uploaderUserId" placeholder="userId" />
          <input id="uploaderPassword" type="password" placeholder="password" />
          <button id="uploaderLogin">登录验证</button>
          <button id="uploaderGenToken">生成 Token</button>
        </div>
        <pre id="uploaderTokenInfo">先输入 userId + password，再点击“生成 Token”。</pre>
      </section>

      <section class="split">
        <div class="card">
          <h3 style="margin: 0 0 8px;">机器列表</h3>
          <div class="small" id="scopeHint">未加载</div>
          <table>
            <thead>
              <tr>
                <th>状态</th>
                <th>machineId</th>
                <th>userId</th>
                <th>account</th>
                <th>最后心跳</th>
              </tr>
            </thead>
            <tbody id="machineRows"></tbody>
          </table>
        </div>

        <div class="card">
          <h3 style="margin: 0 0 8px;">选中机器配置</h3>
          <div class="small" id="selectedHint">先从左侧选择一台机器。</div>
          <div class="form-grid">
            <input id="machineLabel" placeholder="机器名称（可选）" />
            <select id="machineStatus">
              <option value="keep">状态：保持不变</option>
              <option value="online">状态：online</option>
              <option value="offline">状态：offline</option>
            </select>
          </div>

          <table class="routing-table">
            <thead>
              <tr>
                <th>模式</th>
                <th>accountId</th>
                <th>modelHint</th>
                <th>agentHint</th>
                <th>skillsHint</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="mode">quick</td>
                <td><input id="quickAccount" /></td>
                <td><input id="quickModel" /></td>
                <td><input id="quickAgent" /></td>
                <td><input id="quickSkills" /></td>
              </tr>
              <tr>
                <td class="mode">code</td>
                <td><input id="codeAccount" /></td>
                <td><input id="codeModel" /></td>
                <td><input id="codeAgent" /></td>
                <td><input id="codeSkills" /></td>
              </tr>
              <tr>
                <td class="mode">deep</td>
                <td><input id="deepAccount" /></td>
                <td><input id="deepModel" /></td>
                <td><input id="deepAgent" /></td>
                <td><input id="deepSkills" /></td>
              </tr>
              <tr>
                <td class="mode">inst_m2_5</td>
                <td><input id="inst_m2_5Account" /></td>
                <td><input id="inst_m2_5Model" /></td>
                <td><input id="inst_m2_5Agent" /></td>
                <td><input id="inst_m2_5Skills" /></td>
              </tr>
              <tr>
                <td class="mode">inst_glm_4_7</td>
                <td><input id="inst_glm_4_7Account" /></td>
                <td><input id="inst_glm_4_7Model" /></td>
                <td><input id="inst_glm_4_7Agent" /></td>
                <td><input id="inst_glm_4_7Skills" /></td>
              </tr>
              <tr>
                <td class="mode">inst_glm_5</td>
                <td><input id="inst_glm_5Account" /></td>
                <td><input id="inst_glm_5Model" /></td>
                <td><input id="inst_glm_5Agent" /></td>
                <td><input id="inst_glm_5Skills" /></td>
              </tr>
            </tbody>
          </table>

          <div class="actions">
            <button id="saveConfig">保存到服务器</button>
            <button class="muted-btn" id="reloadSelected">重新读取</button>
          </div>
        </div>
      </section>

      <section class="card">
        <h3 style="margin: 0 0 8px;">机器贡献者注册（无密码）</h3>
        <p class="small">点一次创建贡献者凭据，得到 machine token。把命令复制到本地 OpenClaw 机器执行即可。</p>
        <div class="deploy-grid">
          <input id="deployServer" placeholder="Server URL" />
          <input id="contributorMachineLabel" placeholder="机器显示名（可选）" />
          <input id="contributorMachineId" placeholder="machineId（可选）" />
          <input id="contributorPassword" type="password" placeholder="贡献者密码（必填）" />
          <input id="contributorAccountId" placeholder="accountId（默认 default）" />
          <button id="createContributor">注册贡献者</button>
        </div>
        <pre id="contributorInfo">先点击“注册贡献者”。</pre>

        <h3 style="margin: 14px 0 8px;">OpenClaw 机器一键接入命令</h3>
        <pre id="deployCommand">先注册贡献者后会自动生成命令。</pre>
        <div class="actions">
          <button id="copyCommand">复制命令</button>
        </div>
      </section>
    </div>

    <script>
      const modes = ["quick", "code", "deep", "inst_m2_5", "inst_glm_4_7", "inst_glm_5"];
      const state = {
        machines: [],
        selectedMachineId: "",
      };

      const baseUrlEl = document.getElementById("baseUrl");
      const authTokenEl = document.getElementById("authToken");
      const userIdEl = document.getElementById("userId");
      const loadBtn = document.getElementById("loadMachines");
      const statusEl = document.getElementById("status");
      const scopeHintEl = document.getElementById("scopeHint");
      const rowsEl = document.getElementById("machineRows");
      const selectedHintEl = document.getElementById("selectedHint");

      const machineLabelEl = document.getElementById("machineLabel");
      const machineStatusEl = document.getElementById("machineStatus");
      const saveConfigBtn = document.getElementById("saveConfig");
      const reloadSelectedBtn = document.getElementById("reloadSelected");

      const deployServerEl = document.getElementById("deployServer");
      const uploaderUserIdEl = document.getElementById("uploaderUserId");
      const uploaderPasswordEl = document.getElementById("uploaderPassword");
      const uploaderTokenInfoEl = document.getElementById("uploaderTokenInfo");
      const uploaderLoginBtn = document.getElementById("uploaderLogin");
      const uploaderGenTokenBtn = document.getElementById("uploaderGenToken");
      const contributorMachineLabelEl = document.getElementById("contributorMachineLabel");
      const contributorMachineIdEl = document.getElementById("contributorMachineId");
      const contributorPasswordEl = document.getElementById("contributorPassword");
      const contributorAccountIdEl = document.getElementById("contributorAccountId");
      const contributorInfoEl = document.getElementById("contributorInfo");
      const createContributorBtn = document.getElementById("createContributor");
      const deployCommandEl = document.getElementById("deployCommand");
      const copyCommandBtn = document.getElementById("copyCommand");

      let currentContributor = null;
      let currentUploaderToken = "";

      function modeInput(mode, field) {
        return document.getElementById(`${mode}${field}`);
      }

      function cleanBaseUrl(raw) {
        const trimmed = String(raw || "").trim();
        if (!trimmed) return window.location.origin;
        return trimmed.replace(/\/$/, "");
      }

      function machinePath(machineId) {
        return `/api/machines/${encodeURIComponent(machineId)}`;
      }

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function authHeaders() {
        const headers = { "Content-Type": "application/json" };
        const token = authTokenEl.value.trim();
        const userId = userIdEl.value.trim();
        if (token) headers.Authorization = `Bearer ${token}`;
        if (userId) headers["x-vimalinx-user"] = userId;
        return headers;
      }

      function authQuery() {
        const userId = userIdEl.value.trim();
        if (!userId) return "";
        return `?userId=${encodeURIComponent(userId)}`;
      }

      function formatTime(ts) {
        if (!ts) return "-";
        const d = new Date(Number(ts));
        if (Number.isNaN(d.getTime())) return "-";
        return d.toLocaleString();
      }

      function rowTemplate(machine) {
        const picked = machine.machineId === state.selectedMachineId ? "pick" : "";
        const statusClass = machine.status === "online" ? "online" : "offline";
        return `<tr class="${picked}" data-machine-id="${machine.machineId}">
          <td><span class="pill ${statusClass}">${machine.status}</span></td>
          <td>${machine.machineId}</td>
          <td>${machine.userId || "-"}</td>
          <td>${machine.accountId || "-"}</td>
          <td>${formatTime(machine.lastSeenAt)}</td>
        </tr>`;
      }

      function renderRows() {
        if (state.machines.length === 0) {
          rowsEl.innerHTML = `<tr><td colspan="5" class="small">暂无机器，先让本地 OpenClaw 节点启动一次。</td></tr>`;
          return;
        }
        rowsEl.innerHTML = state.machines.map((machine) => rowTemplate(machine)).join("");
      }

      function toMap(modeField) {
        const out = {};
        for (const mode of modes) {
          const val = modeInput(mode, modeField).value.trim();
          if (val) out[mode] = val;
        }
        return Object.keys(out).length > 0 ? out : null;
      }

      function resetModeFields() {
        for (const mode of modes) {
          modeInput(mode, "Account").value = "";
          modeInput(mode, "Model").value = "";
          modeInput(mode, "Agent").value = "";
          modeInput(mode, "Skills").value = "";
        }
      }

      function setModeFields(routing) {
        resetModeFields();
        const accountMap = routing?.modeAccountMap || {};
        const modelMap = routing?.modeModelHints || {};
        const agentMap = routing?.modeAgentHints || {};
        const skillsMap = routing?.modeSkillsHints || {};
        for (const mode of modes) {
          modeInput(mode, "Account").value = accountMap[mode] || "";
          modeInput(mode, "Model").value = modelMap[mode] || "";
          modeInput(mode, "Agent").value = agentMap[mode] || "";
          modeInput(mode, "Skills").value = skillsMap[mode] || "";
        }
      }

      function applySelectedMachine(machine) {
        if (!machine) {
          selectedHintEl.textContent = "先从左侧选择一台机器。";
          machineLabelEl.value = "";
          machineStatusEl.value = "keep";
          resetModeFields();
          return;
        }
        selectedHintEl.textContent = `${machine.machineId} · user=${machine.userId || "-"}`;
        machineLabelEl.value = machine.machineLabel || "";
        machineStatusEl.value = "keep";
        setModeFields(machine.routing || {});
      }

      function selectedMachine() {
        return state.machines.find((item) => item.machineId === state.selectedMachineId) || null;
      }

      async function requestJson(url, options) {
        const response = await fetch(url, options);
        const data = await response.json().catch(() => ({}));
        if (!response.ok || data.ok === false) {
          const message = data.error || `HTTP ${response.status}`;
          throw new Error(message);
        }
        return data;
      }

      async function loadMachines() {
        const baseUrl = cleanBaseUrl(baseUrlEl.value);
        baseUrlEl.value = baseUrl;
        setStatus("加载中...");
        try {
          const data = await requestJson(`${baseUrl}/api/machines${authQuery()}`, {
            method: "GET",
            headers: authHeaders(),
          });
          state.machines = Array.isArray(data.machines) ? data.machines : [];
          scopeHintEl.textContent = `访问范围：${data.scope || "unknown"}，机器数：${state.machines.length}`;
          if (!state.machines.some((item) => item.machineId === state.selectedMachineId)) {
            state.selectedMachineId = state.machines[0]?.machineId || "";
          }
          renderRows();
          applySelectedMachine(selectedMachine());
          setStatus("机器池加载成功。");
        } catch (error) {
          setStatus(`加载失败：${error.message}`);
          scopeHintEl.textContent = "加载失败";
          state.machines = [];
          state.selectedMachineId = "";
          renderRows();
          applySelectedMachine(null);
        }
      }

      async function reloadSelectedMachine() {
        const selected = selectedMachine();
        if (!selected) {
          setStatus("请先选择机器。");
          return;
        }
        const baseUrl = cleanBaseUrl(baseUrlEl.value);
        try {
          const data = await requestJson(`${baseUrl}${machinePath(selected.machineId)}${authQuery()}`, {
            method: "GET",
            headers: authHeaders(),
          });
          const fresh = data.machine;
          state.machines = state.machines.map((item) =>
            item.machineId === fresh.machineId ? fresh : item,
          );
          renderRows();
          applySelectedMachine(fresh);
          setStatus("已刷新选中机器。");
        } catch (error) {
          setStatus(`刷新失败：${error.message}`);
        }
      }

      async function saveSelectedMachine() {
        const selected = selectedMachine();
        if (!selected) {
          setStatus("请先选择机器。");
          return;
        }

        const routing = {};
        const accountMap = toMap("Account");
        const modelMap = toMap("Model");
        const agentMap = toMap("Agent");
        const skillsMap = toMap("Skills");
        if (accountMap) routing.modeAccountMap = accountMap;
        if (modelMap) routing.modeModelHints = modelMap;
        if (agentMap) routing.modeAgentHints = agentMap;
        if (skillsMap) routing.modeSkillsHints = skillsMap;

        const payload = {
          machineLabel: machineLabelEl.value.trim(),
        };
        if (Object.keys(routing).length > 0) {
          payload.routing = routing;
        }
        if (machineStatusEl.value !== "keep") {
          payload.status = machineStatusEl.value;
        }

        const baseUrl = cleanBaseUrl(baseUrlEl.value);
        setStatus("保存中...");
        try {
          const data = await requestJson(`${baseUrl}${machinePath(selected.machineId)}${authQuery()}`, {
            method: "PATCH",
            headers: authHeaders(),
            body: JSON.stringify(payload),
          });
          const fresh = data.machine;
          state.machines = state.machines.map((item) =>
            item.machineId === fresh.machineId ? fresh : item,
          );
          renderRows();
          applySelectedMachine(fresh);
          setStatus("保存成功。配置会通过心跳同步到插件。");
        } catch (error) {
          setStatus(`保存失败：${error.message}`);
        }
      }

      function buildDeployCommand() {
        const baseUrl = cleanBaseUrl(deployServerEl.value || baseUrlEl.value);
        deployServerEl.value = baseUrl;
        const selectedToken = currentContributor?.token || currentUploaderToken;
        const selectedUserId = currentContributor?.userId || uploaderUserIdEl.value.trim();
        if (!selectedToken) {
          deployCommandEl.textContent = "先注册贡献者或在上方生成上传者 Token。";
          return;
        }
        const parts = [
          "git clone https://github.com/vimalinx/ClawNet.git",
          "cd ClawNet",
          `bash scripts/deploy-openclaw-node.sh --server-url ${JSON.stringify(baseUrl)} --token ${JSON.stringify(selectedToken)}`,
        ];
        if (selectedUserId) {
          parts[2] += ` --user-id ${JSON.stringify(selectedUserId)}`;
        }
        if (currentContributor?.machineId) {
          parts[2] += ` --machine-id ${JSON.stringify(currentContributor.machineId)}`;
        }
        if (currentContributor?.machineLabel) {
          parts[2] += ` --machine-label ${JSON.stringify(currentContributor.machineLabel)}`;
        }
        deployCommandEl.textContent = parts.join(" && ");
      }

      async function createContributor() {
        const baseUrl = cleanBaseUrl(deployServerEl.value || baseUrlEl.value);
        deployServerEl.value = baseUrl;
        const payload = {};
        const machineLabel = contributorMachineLabelEl.value.trim();
        const machineId = contributorMachineIdEl.value.trim();
        const password = contributorPasswordEl.value;
        const accountId = contributorAccountIdEl.value.trim();
        if (!password || password.trim().length < 6) {
          setStatus("贡献者密码必填，且长度至少 6 位。");
          return;
        }
        if (machineLabel) payload.machineLabel = machineLabel;
        if (machineId) payload.machineId = machineId;
        payload.password = password;
        if (accountId) payload.accountId = accountId;

        setStatus("注册贡献者中...");
        createContributorBtn.disabled = true;
        try {
          const data = await requestJson(`${baseUrl}/api/machines/contributors`, {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify(payload),
          });
          const contributor = data.contributor || {};
          const machine = data.machine || {};
          currentContributor = {
            userId: contributor.userId || "",
            token: contributor.token || "",
            machineId: contributor.machineId || machine.machineId || "",
            machineLabel: machine.machineLabel || machineLabel || "",
          };
          contributorPasswordEl.value = "";
          contributorInfoEl.textContent = `userId: ${currentContributor.userId || "-"}\n` +
            `token: ${currentContributor.token || "-"}\n` +
            `machineId: ${currentContributor.machineId || "-"}\n` +
            `accountId: ${contributor.accountId || machine.accountId || "default"}`;
          if (currentContributor.userId) userIdEl.value = currentContributor.userId;
          if (currentContributor.token) authTokenEl.value = currentContributor.token;
          localStorage.setItem("test_user_id", userIdEl.value.trim());
          localStorage.setItem("test_user_token", authTokenEl.value.trim());
          buildDeployCommand();
          await loadMachines();
          setStatus("贡献者注册成功，命令已生成。");
        } catch (error) {
          setStatus(`注册失败：${error.message}`);
        } finally {
          createContributorBtn.disabled = false;
        }
      }

      async function uploaderLogin() {
        const baseUrl = cleanBaseUrl(baseUrlEl.value);
        const userId = uploaderUserIdEl.value.trim();
        const password = uploaderPasswordEl.value;
        if (!userId || !password) {
          setStatus("请先输入上传者 userId 和 password。");
          return;
        }
        uploaderLoginBtn.disabled = true;
        try {
          const data = await requestJson(`${baseUrl}/api/account/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, password }),
          });
          uploaderTokenInfoEl.textContent = `登录成功\nuserId: ${data.userId || userId}\ndisplayName: ${data.displayName || "-"}`;
          setStatus("上传者登录验证成功。");
        } catch (error) {
          setStatus(`上传者登录失败：${error.message}`);
        } finally {
          uploaderLoginBtn.disabled = false;
        }
      }

      async function uploaderGenerateToken() {
        const baseUrl = cleanBaseUrl(baseUrlEl.value);
        const userId = uploaderUserIdEl.value.trim();
        const password = uploaderPasswordEl.value;
        if (!userId || !password) {
          setStatus("请先输入上传者 userId 和 password。");
          return;
        }
        uploaderGenTokenBtn.disabled = true;
        try {
          const data = await requestJson(`${baseUrl}/api/token`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId, password }),
          });
          currentUploaderToken = data.token || "";
          uploaderTokenInfoEl.textContent = `Token 生成成功\nuserId: ${data.userId || userId}\ntoken: ${currentUploaderToken || "-"}`;
          authTokenEl.value = currentUploaderToken || authTokenEl.value;
          userIdEl.value = data.userId || userId;
          localStorage.setItem("test_user_id", userIdEl.value.trim());
          localStorage.setItem("test_user_token", authTokenEl.value.trim());
          setStatus("上传者 Token 已生成，可直接用于机器接入。");
        } catch (error) {
          setStatus(`生成 Token 失败：${error.message}`);
        } finally {
          uploaderGenTokenBtn.disabled = false;
        }
      }

      async function copyDeployCommand() {
        try {
          await navigator.clipboard.writeText(deployCommandEl.textContent || "");
          setStatus("命令已复制。去本地 OpenClaw 机器粘贴执行即可。");
        } catch {
          setStatus("复制失败，请手动复制命令。");
        }
      }

      rowsEl.addEventListener("click", (event) => {
        const row = event.target.closest("tr[data-machine-id]");
        if (!row) return;
        state.selectedMachineId = row.getAttribute("data-machine-id") || "";
        renderRows();
        applySelectedMachine(selectedMachine());
      });

      loadBtn.addEventListener("click", loadMachines);
      saveConfigBtn.addEventListener("click", saveSelectedMachine);
      reloadSelectedBtn.addEventListener("click", reloadSelectedMachine);
      createContributorBtn.addEventListener("click", createContributor);
      uploaderLoginBtn.addEventListener("click", uploaderLogin);
      uploaderGenTokenBtn.addEventListener("click", uploaderGenerateToken);
      deployServerEl.addEventListener("change", buildDeployCommand);
      copyCommandBtn.addEventListener("click", copyDeployCommand);

      baseUrlEl.value = window.location.origin;
      deployServerEl.value = window.location.origin;
      const savedUserId = localStorage.getItem("test_user_id") || "";
      const savedToken = localStorage.getItem("test_user_token") || "";
      if (savedUserId) {
        userIdEl.value = savedUserId;
        uploaderUserIdEl.value = savedUserId;
      }
      if (savedToken) {
        authTokenEl.value = savedToken;
      }
      setStatus("输入凭据后点“加载机器池”。管理员Token可看全量；用户Token+userId可看自己的机器。" );
      buildDeployCommand();
    </script>
  </body>
</html>
